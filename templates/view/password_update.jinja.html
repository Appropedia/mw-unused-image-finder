{% from 'macros/top_bar.jinja.html' import top_bar %}
<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title> Password update </title>
    <link rel="stylesheet" type="text/css" href="{{url_for('static', filename = 'common.css')}}">
  </head>
  <body>
{% if g.user_password_reset %}
    {{top_bar() | indent(4)}}
    <p> You have accessed your account using an auto-generated password. Please update it now. </p>
{% else %}
    {{top_bar('Back to main', 'default.get') | indent(4)}}
    <p> You can change your password here. </p>
{% endif %}
    <form id="password_update_form" action="{{user_password_update_url}}" data-method="patch">
      <div>
        <label for="current_password">Current password:</label>
        <input type="password" id="current_password" name="current_password" required>
      </div>
      <div>
        <label for="new_password">New password:</label>
        <input type="password" id="new_password" name="new_password" required>
      </div>
      <div>
        <label for="confirmed_password">Confirm password:</label>
        <input type="password" id="confirmed_password" name="confirmed_password" required>
      </div>
      <div>
        <button type="submit">Update</button>
      </div>
    </form>
    <style>
      div.form_submit_result.success { color: initial; }
      div.form_submit_result.error { color: red; }
    </style>
    <div id="form_submit_result" class="form_submit_result"></div>
{% if g.user_password_reset %}
    <div id="success_message"></div>
{% endif %}
    <script type="module">
      import { register_submit_listener }
      from {{url_for('static', filename = 'simple_form_listener.js') | tojson}};

      const messages = {
        'OK': 'Your password has been updated.',
        'INVALID_VALUE,current_password': 'Current password is incorrect.',
        'FIELD_MISMATCH,new_password,confirmed_password': 'New passwords don\'t match. Try again.',
      };
      const password_update_form = document.getElementById('password_update_form');
      const form_submit_result = document.getElementById('form_submit_result');
{% if g.user_password_reset %}
      const success_message = document.getElementById('success_message');
      const main_page_url = {{url_for('default.get') | tojson}};

      function form_submit_callback(success, response_text) {
        if (success) success_message.innerHTML =
          `You may now proceed to the <a href="${main_page_url}">main page</a>`;

        return messages[response_text];
      }
{% else %}

      function form_submit_callback(success, response_text) {
        return messages[response_text];
      }
{% endif %}

      register_submit_listener(password_update_form, form_submit_result,
                               { callback: form_submit_callback });
    </script>
  </body>
</html>
